# Pipeline CI/CD - Mon École et Moi
stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  PHP_VERSION: "8.3"

# Cache pour optimiser les builds
cache:
  paths:
    - frontend/node_modules/
    - backend/vendor/

# Tests Backend Laravel
test:backend:
  stage: test
  image: php:${PHP_VERSION}-cli
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl libmcrypt-dev libjpeg-dev libpng-dev libfreetype6-dev libbz2-dev libzip-dev unzip
    - docker-php-ext-install zip pdo_mysql
    - curl -sS https://getcomposer.org/installer | php
    - mv composer.phar /usr/local/bin/composer
    - cd backend
    - composer install --no-interaction --prefer-dist --optimize-autoloader
  script:
    - cp .env.example .env
    - php artisan key:generate
    - php artisan config:cache
    - php artisan route:cache
    - php artisan test
  only:
    - develop
    - main
    - merge_requests

# Tests Frontend Next.js
test:frontend:
  stage: test
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint
    - npm run build
    - npm run test --if-present
  only:
    - develop
    - main
    - merge_requests

# Build Production
build:production:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
    - echo "Build terminé avec succès"
  artifacts:
    paths:
      - frontend/.next/
    expire_in: 1 hour
  only:
    - main

# Deploy Staging (optionnel)
deploy:staging:
  stage: deploy
  script:
    - echo "Déploiement staging - À configurer selon l'infrastructure"
    - echo "Frontend build disponible dans frontend/.next/"
  only:
    - develop
  when: manual

# Deploy Production (optionnel)
deploy:production:
  stage: deploy
  script:
    - echo "Déploiement production - À configurer selon l'infrastructure"
    - echo "Frontend build disponible dans frontend/.next/"
  only:
    - main
  when: manual
  environment:
    name: production
