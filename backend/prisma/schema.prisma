generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                  @id @default(autoincrement())
  email               String               @unique
  password            String
  name                String
  nom                 String?
  prenom              String?
  dateNaissance       DateTime?            @map("date_naissance")
  adresse             String?
  telephone           String?
  role                Role                 @default(PARENT)
  actif               Boolean              @default(true)
  premiereConnexion   Boolean              @default(true) @map("premiere_connexion")
  emailVerifiedAt     DateTime?            @map("email_verified_at")
  rememberToken       String?              @map("remember_token")
  resetTokenExpiresAt DateTime?            @map("reset_token_expires_at")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  deletedAt           DateTime?            @map("deleted_at")
  enfantsParent1      Enfant[]             @relation("Parent1")
  enfantsParent2      Enfant[]             @relation("Parent2")
  factures            Facture[]
  inscriptions        Inscription[]
  pdfOuvertures       PdfOuverture[]
  sessions            Session[]
  signatureReglements SignatureReglement[]

  @@index([role])
  @@index([actif])
  @@index([role, actif])
  @@index([deletedAt])
  @@map("users")
}

model Session {
  id           String  @id
  userId       Int     @map("user_id")
  ipAddress    String? @map("ip_address")
  userAgent    String? @map("user_agent")
  payload      String
  lastActivity Int     @map("last_activity")
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Preinscription {
  id                     Int                  @id @default(autoincrement())
  numeroDossier          String               @unique @map("numero_dossier")
  nomEnfant              String               @map("nom_enfant")
  prenomEnfant           String               @map("prenom_enfant")
  dateNaissance          DateTime             @map("date_naissance")
  lieuNaissance          String?              @map("lieu_naissance")
  nationalite            String?
  allergies              String?
  classeSouhaitee        Classe               @map("classe_souhaitee")
  etablissementPrecedent String?              @map("etablissement_precedent")
  classeActuelle         String?              @map("classe_actuelle")
  civiliteParent         String?              @map("civilite_parent")
  nomParent              String               @map("nom_parent")
  prenomParent           String               @map("prenom_parent")
  emailParent            String               @map("email_parent")
  telephoneParent        String               @map("telephone_parent")
  lienParente            String?              @map("lien_parente")
  adresseParent          String?              @map("adresse_parent")
  professionParent       String?              @map("profession_parent")
  civiliteParent2        String?              @map("civilite_parent2")
  nomParent2             String?              @map("nom_parent2")
  prenomParent2          String?              @map("prenom_parent2")
  emailParent2           String?              @map("email_parent2")
  telephoneParent2       String?              @map("telephone_parent2")
  lienParente2           String?              @map("lien_parente2")
  adresseParent2         String?              @map("adresse_parent2")
  professionParent2      String?              @map("profession_parent2")
  dateIntegration        DateTime?            @map("date_integration")
  dateDemande            DateTime             @default(now()) @map("date_demande")
  statut                 StatutPreinscription @default(EN_ATTENTE)
  compteCree             Boolean              @default(false) @map("compte_cree")
  commentaireRefus       String?              @map("commentaire_refus")
  situationFamiliale     SituationFamiliale?  @map("situation_familiale")
  situationAutre         String?              @map("situation_autre")
  decouverte             String?
  pedagogieMontessori    String?              @map("pedagogie_montessori")
  difficultes            String?
  createdAt              DateTime             @default(now()) @map("created_at")
  updatedAt              DateTime             @updatedAt @map("updated_at")
  emailVerifie           Boolean              @default(false) @map("email_verifie")
  tokenExpiresAt         DateTime?            @map("token_expires_at")
  tokenVerification      String?              @unique @map("token_verification")
  enfants                Enfant[]

  @@index([statut])
  @@index([emailParent])
  @@index([dateDemande])
  @@map("preinscriptions")
}

model Enfant {
  id                  Int                 @id @default(autoincrement()) @map("id_enfant")
  nom                 String
  prenom              String
  dateNaissance       DateTime?           @map("date_naissance")
  lieuNaissance       String?             @map("lieu_naissance")
  classe              Classe?
  parent1Id           Int                 @map("id_parent1")
  parent2Id           Int?                @map("id_parent2")
  preinscriptionId    Int?                @map("preinscription_id")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  deletedAt           DateTime?           @map("deleted_at")
  parent1             User                @relation("Parent1", fields: [parent1Id], references: [id], onDelete: Cascade)
  parent2             User?               @relation("Parent2", fields: [parent2Id], references: [id], onDelete: Cascade)
  preinscription      Preinscription?     @relation(fields: [preinscriptionId], references: [id])
  inscriptions        Inscription[]
  justificatifs       Justificatif[]
  pdfOuvertures       PdfOuverture[]
  periscolaires       Periscolaire[]
  personnesAutorisees PersonneAutorisee[]
  repas               Repas[]
  signatureReglements SignatureReglement?

  @@index([classe])
  @@index([parent1Id])
  @@index([preinscriptionId])
  @@index([deletedAt])
  @@map("enfants")
}

model PersonneAutorisee {
  id          Int      @id @default(autoincrement())
  enfantId    Int      @map("enfant_id")
  nom         String
  prenom      String
  telephone   String
  lienParente String?  @map("lien_parente")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  enfant      Enfant   @relation(fields: [enfantId], references: [id], onDelete: Cascade)

  @@index([enfantId])
  @@map("personnes_autorisees")
}

model Inscription {
  id              Int               @id @default(autoincrement()) @map("id_inscription")
  enfantId        Int               @map("id_enfant")
  parentId        Int?              @map("id_parent")
  dateInscription DateTime          @map("date_inscription")
  statut          StatutInscription
  commentaires    String?
  anneeScolaire   String            @map("annee_scolaire")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  enfant          Enfant            @relation(fields: [enfantId], references: [id], onDelete: Cascade)
  parent          User?             @relation(fields: [parentId], references: [id])

  @@index([enfantId])
  @@index([parentId])
  @@index([anneeScolaire])
  @@index([statut])
  @@map("inscriptions")
}

model Repas {
  id        Int       @id @default(autoincrement()) @map("id_repas")
  enfantId  Int       @map("id_enfant")
  dateRepas DateTime  @map("date_repas")
  type      TypeRepas
  valide    Boolean?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  enfant    Enfant    @relation(fields: [enfantId], references: [id], onDelete: Cascade)

  @@unique([enfantId, dateRepas, type])
  @@index([dateRepas])
  @@index([enfantId, dateRepas])
  @@map("repas")
}

model Periscolaire {
  id               Int      @id @default(autoincrement()) @map("id_periscolaire")
  enfantId         Int      @map("id_enfant")
  datePeriscolaire DateTime @map("date_periscolaire")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  enfant           Enfant   @relation(fields: [enfantId], references: [id], onDelete: Cascade)

  @@unique([enfantId, datePeriscolaire])
  @@index([datePeriscolaire])
  @@index([enfantId, datePeriscolaire])
  @@map("periscolaires")
}

model JustificatifAttendu {
  id            Int            @id @default(autoincrement()) @map("id_type")
  nom           String
  description   String?
  obligatoire   Boolean?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  justificatifs Justificatif[]

  @@map("justificatifs_attendus")
}

model Justificatif {
  id         Int                 @id @default(autoincrement()) @map("id_justificatif")
  enfantId   Int                 @map("id_enfant")
  typeId     Int                 @map("id_type")
  fichierUrl String              @map("fichier_url")
  valide     Boolean?
  dateDepot  DateTime?           @map("date_depot")
  createdAt  DateTime            @default(now()) @map("created_at")
  updatedAt  DateTime            @updatedAt @map("updated_at")
  enfant     Enfant              @relation(fields: [enfantId], references: [id], onDelete: Cascade)
  type       JustificatifAttendu @relation(fields: [typeId], references: [id], onDelete: Cascade)

  @@index([enfantId])
  @@index([valide])
  @@index([enfantId, typeId])
  @@map("justificatifs")
}

model SignatureReglement {
  id                          Int       @id @default(autoincrement())
  enfantId                    Int       @unique @map("enfant_id")
  parentId                    Int       @map("parent_id")
  parentName                  String    @map("parent_name")
  parentEmail                 String    @map("parent_email")
  enfantName                  String    @map("enfant_name")
  parentDateSignature         DateTime? @map("parent_date_signature")
  enfantDateSignature         DateTime? @map("enfant_date_signature")
  parentAccepte               Boolean   @default(false) @map("parent_accepte")
  enfantAccepte               Boolean   @default(false) @map("enfant_accepte")
  parentSignatureElectronique String?   @map("parent_signature_electronique")
  enfantSignatureElectronique String?   @map("enfant_signature_electronique")
  parentIpAdresse             String?   @map("parent_ip_adresse")
  enfantIpAdresse             String?   @map("enfant_ip_adresse")
  notes                       String?
  createdAt                   DateTime  @default(now()) @map("created_at")
  updatedAt                   DateTime  @updatedAt @map("updated_at")
  enfant                      Enfant    @relation(fields: [enfantId], references: [id], onDelete: Cascade)
  parent                      User      @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@index([parentId])
  @@index([parentAccepte])
  @@map("signature_reglements")
}

model PdfOuverture {
  id        Int      @id @default(autoincrement())
  enfantId  Int      @map("enfant_id")
  parentId  Int      @map("parent_id")
  pdfType   String   @map("pdf_type")
  openedAt  DateTime @default(now()) @map("opened_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  enfant    Enfant   @relation(fields: [enfantId], references: [id], onDelete: Cascade)
  parent    User     @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@index([enfantId])
  @@index([parentId])
  @@index([openedAt])
  @@map("pdf_ouvertures")
}

model Facture {
  id           Int            @id @default(autoincrement()) @map("id_facture")
  numero       String         @unique
  parentId     Int            @map("parent_id")
  montantTotal Decimal        @map("montant_total") @db.Decimal(10, 2)
  montantPaye  Decimal        @default(0) @map("montant_paye") @db.Decimal(10, 2)
  dateEmission DateTime       @map("date_emission")
  dateEcheance DateTime       @map("date_echeance")
  periode      String?
  description  String?
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  statut       StatutFacture  @default(EN_ATTENTE)
  type         TypeFacture
  parent       User           @relation(fields: [parentId], references: [id], onDelete: Cascade)
  lignes       LigneFacture[]

  @@index([parentId])
  @@index([statut])
  @@index([dateEcheance])
  @@index([statut, dateEcheance])
  @@index([periode])
  @@map("factures")
}

model LigneFacture {
  id          Int      @id @default(autoincrement())
  factureId   Int      @map("facture_id")
  description String
  quantite    Int      @default(1)
  prixUnit    Decimal  @map("prix_unit") @db.Decimal(10, 2)
  montant     Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  facture     Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)

  @@index([factureId])
  @@map("lignes_factures")
}

model CalendrierScolaire {
  id            Int                     @id @default(autoincrement())
  dateDebut     DateTime                @map("date_debut")
  dateFin       DateTime                @map("date_fin")
  libelle       String
  anneeScolaire String                  @map("annee_scolaire")
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")
  type          TypeEvenementCalendrier

  @@index([anneeScolaire])
  @@index([dateDebut, dateFin])
  @@index([type])
  @@map("calendrier_scolaire")
}

enum Role {
  PARENT
  ADMIN
  EDUCATEUR
}

enum StatutPreinscription {
  EN_ATTENTE
  DEJA_CONTACTE
  VALIDE
  REFUSE
  ANNULE
}

enum StatutInscription {
  EN_COURS
  ACTIVE
  TERMINEE
  ANNULEE
}

enum Classe {
  MATERNELLE
  ELEMENTAIRE
  COLLEGE
}

enum SituationFamiliale {
  MARIES
  PACSES
  UNION_LIBRE
  SEPARES
  DIVORCES
  FAMILLE_MONOPARENTALE
  AUTRE
}

enum TypeRepas {
  MIDI
  GOUTER
}

enum StatutFacture {
  EN_ATTENTE
  ENVOYEE
  PAYEE
  PARTIELLE
  EN_RETARD
  ANNULEE
}

enum TypeFacture {
  MENSUELLE
  PONCTUELLE
  AVOIR
}

enum TypeEvenementCalendrier {
  VACANCES
  FERIE
  PONT
  JOURNEE_SPECIALE
}
